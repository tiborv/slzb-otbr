# Kubernetes Example for SLZB-OTBR
# Demonstrates how to run OTBR as a sidecar to Home Assistant with robust TLV extraction.

---
apiVersion: v1
kind: Namespace
metadata:
  name: home-assistant
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: home-assistant-data
  namespace: home-assistant
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 2Gi
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: otbr-data
  namespace: home-assistant
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 1Gi
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: home-assistant
  namespace: home-assistant
  labels:
    app: home-assistant
spec:
  serviceName: home-assistant
  replicas: 1
  selector:
    matchLabels:
      app: home-assistant
  template:
    metadata:
      labels:
        app: home-assistant
    spec:
      hostNetwork: true
      dnsPolicy: ClusterFirstWithHostNet
      volumes:
      # Persistent Data for HA
      - name: data
        persistentVolumeClaim:
          claimName: home-assistant-data
      
      # Persistent Data for OTBR
      - name: otbr-data
        persistentVolumeClaim:
          claimName: otbr-data

      # ========================================================
      # SHARED VOLUME
      # Allows 'tlv-extractor' to write the dataset file, 
      # and 'otbr' to read it.
      # ========================================================
      - name: shared-data
        emptyDir: {}
        
      # Device nodes (tun needed for OTBR)
      - name: dev-net-tun
        hostPath:
          path: /dev/net/tun

      containers:
      # =======================================================================
      # 1. Home Assistant Core
      # =======================================================================
      - name: home-assistant
        image: homeassistant/home-assistant:stable
        ports:
        - containerPort: 8123
        volumeMounts:
        - mountPath: /config
          name: data
        livenessProbe:
          httpGet:
            path: /
            port: 8123
        readinessProbe:
          httpGet:
            path: /
            port: 8123

      # =======================================================================
      # 2. TLV Extractor Sidecar
      # -----------------------------------------------------------------------
      # Watches Home Assistant's internal storage file.
      # Extracts the Thread TLV and writes it to the shared volume.
      # =======================================================================
      - name: tlv-extractor
        image: ghcr.io/jqlang/jq:latest
        command:
          - /bin/sh
          - -c
          - |
            echo "Starting TLV extractor..."
            # Periodically sync credential from HA storage to shared volume
            while true; do
              if [ -f /config/.storage/thread.datasets ]; then
                # Extract preferred dataset TLV (or first one)
                jq -r '.data.datasets[] | select(.id == .data.preferred_dataset) | .tlv // .data.datasets[0].tlv // empty' /config/.storage/thread.datasets > /shared/dataset_tmp.hex
                if [ -s /shared/dataset_tmp.hex ]; then
                  mv /shared/dataset_tmp.hex /shared/dataset.hex
                fi
              fi
              sleep 60
            done
        volumeMounts:
        - name: data
          mountPath: /config
          readOnly: true
        - name: shared-data
          mountPath: /shared

      # =======================================================================
      # 3. SLZB-OTBR Sidecar
      # =======================================================================
      - name: otbr
        image: ghcr.io/tiborv/slzb-otbr:latest
        securityContext:
          privileged: true
          capabilities:
            add: ["NET_ADMIN", "SYS_MODULE"]
        env:
        # ----------------------------------------------------
        # Configuration
        # ----------------------------------------------------
        - name: SLZB_HOST
          value: "192.168.1.X"  # <--- REPLACE WITH YOUR IP
        - name: SLZB_PORT
          value: "6638"
        
        # Read TLV from the file provided by the extractor sidecar
        - name: TLV_FILE_PATH
          value: "/shared/dataset.hex"
        
        # Enable mDNS discovery (requires hostNetwork: true)
        - name: MDNS_PUBLISH
          value: "true"
        
        volumeMounts:
        - name: dev-net-tun
          mountPath: /dev/net/tun
        - name: otbr-data
          mountPath: /data
        - name: shared-data
          mountPath: /shared

        ports:
        - containerPort: 8081
          name: otbr-rest

---
apiVersion: v1
kind: Service
metadata:
  name: home-assistant
  namespace: home-assistant
spec:
  selector:
    app: home-assistant
  ports:
  - port: 80
    targetPort: 8123
    name: http
